{"ast":null,"code":"/**\n    * @license\n    * Copyright 2020 Google LLC. All Rights Reserved.\n    * Licensed under the Apache License, Version 2.0 (the \"License\");\n    * you may not use this file except in compliance with the License.\n    * You may obtain a copy of the License at\n    *\n    * http://www.apache.org/licenses/LICENSE-2.0\n    *\n    * Unless required by applicable law or agreed to in writing, software\n    * distributed under the License is distributed on an \"AS IS\" BASIS,\n    * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    * See the License for the specific language governing permissions and\n    * limitations under the License.\n    * =============================================================================\n    */\nimport { slice, add, div, sub, mul, concat2d, Tensor, tidy, concat, tensor1d, tensor2d, sigmoid, image, browser } from \"@tensorflow/tfjs-core\";\nimport { loadGraphModel } from \"@tensorflow/tfjs-converter\";\n\nconst disposeBox = t => {\n  t.startEndTensor.dispose(), t.startPoint.dispose(), t.endPoint.dispose();\n},\n      createBox = t => ({\n  startEndTensor: t,\n  startPoint: slice(t, [0, 0], [-1, 2]),\n  endPoint: slice(t, [0, 2], [-1, 2])\n}),\n      scaleBox = (t, o) => {\n  const s = mul(t.startPoint, o),\n        e = mul(t.endPoint, o),\n        i = concat2d([s, e], 1);\n  return createBox(i);\n},\n      ANCHORS_CONFIG = {\n  strides: [8, 16],\n  anchors: [2, 6]\n},\n      NUM_LANDMARKS = 6;\n\nfunction generateAnchors(t, o, s) {\n  const e = [];\n\n  for (let i = 0; i < s.strides.length; i++) {\n    const n = s.strides[i],\n          a = Math.floor((o + n - 1) / n),\n          r = Math.floor((t + n - 1) / n),\n          c = s.anchors[i];\n\n    for (let t = 0; t < a; t++) {\n      const o = n * (t + .5);\n\n      for (let t = 0; t < r; t++) {\n        const s = n * (t + .5);\n\n        for (let t = 0; t < c; t++) e.push([s, o]);\n      }\n    }\n  }\n\n  return e;\n}\n\nfunction decodeBounds(t, o, s) {\n  const e = slice(t, [0, 1], [-1, 2]),\n        i = add(e, o),\n        n = slice(t, [0, 3], [-1, 2]),\n        a = div(n, s),\n        r = div(i, s),\n        c = div(a, 2),\n        l = sub(r, c),\n        d = add(r, c),\n        h = mul(l, s),\n        p = mul(d, s);\n  return concat2d([h, p], 1);\n}\n\nfunction getInputTensorDimensions(t) {\n  return t instanceof Tensor ? [t.shape[0], t.shape[1]] : [t.height, t.width];\n}\n\nfunction flipFaceHorizontal(t, o) {\n  let s, e, i;\n\n  if (t.topLeft instanceof Tensor && t.bottomRight instanceof Tensor) {\n    const [n, a] = tidy(() => [concat([sub(o - 1, t.topLeft.slice(0, 1)), t.topLeft.slice(1, 1)]), concat([sub(o - 1, t.bottomRight.slice(0, 1)), t.bottomRight.slice(1, 1)])]);\n    s = n, e = a, null != t.landmarks && (i = tidy(() => {\n      const s = sub(tensor1d([o - 1, 0]), t.landmarks),\n            e = tensor1d([1, -1]);\n      return mul(s, e);\n    }));\n  } else {\n    const [n, a] = t.topLeft,\n          [r, c] = t.bottomRight;\n    s = [o - 1 - n, a], e = [o - 1 - r, c], null != t.landmarks && (i = t.landmarks.map(t => [o - 1 - t[0], t[1]]));\n  }\n\n  const n = {\n    topLeft: s,\n    bottomRight: e\n  };\n  return null != i && (n.landmarks = i), null != t.probability && (n.probability = t.probability instanceof Tensor ? t.probability.clone() : t.probability), n;\n}\n\nfunction scaleBoxFromPrediction(t, o) {\n  return tidy(() => {\n    let s;\n    return s = t.hasOwnProperty(\"box\") ? t.box : t, scaleBox(s, o).startEndTensor.squeeze();\n  });\n}\n\nclass BlazeFaceModel {\n  constructor(t, o, s, e, i, n) {\n    this.blazeFaceModel = t, this.width = o, this.height = s, this.maxFaces = e, this.anchorsData = generateAnchors(o, s, ANCHORS_CONFIG), this.anchors = tensor2d(this.anchorsData), this.inputSizeData = [o, s], this.inputSize = tensor1d([o, s]), this.iouThreshold = i, this.scoreThreshold = n;\n  }\n\n  async getBoundingBoxes(t, o, s = !0) {\n    const [e, i, n] = tidy(() => {\n      const o = t.resizeBilinear([this.width, this.height]),\n            s = mul(sub(o.div(255), .5), 2),\n            e = this.blazeFaceModel.predict(s).squeeze(),\n            i = decodeBounds(e, this.anchors, this.inputSize),\n            n = slice(e, [0, 0], [-1, 1]);\n      return [e, i, sigmoid(n).squeeze()];\n    }),\n          a = console.warn;\n\n    console.warn = () => {};\n\n    const r = image.nonMaxSuppression(i, n, this.maxFaces, this.iouThreshold, this.scoreThreshold);\n    console.warn = a;\n    const c = await r.array();\n    r.dispose();\n    let l = c.map(t => slice(i, [t, 0], [1, -1]));\n    o || (l = await Promise.all(l.map(async t => {\n      const o = await t.array();\n      return t.dispose(), o;\n    })));\n    const d = t.shape[1],\n          h = t.shape[2];\n    let p;\n    p = o ? div([h, d], this.inputSize) : [h / this.inputSizeData[0], d / this.inputSizeData[1]];\n    const u = [];\n\n    for (let t = 0; t < l.length; t++) {\n      const i = l[t],\n            a = tidy(() => {\n        const a = createBox(i instanceof Tensor ? i : tensor2d(i));\n        if (!s) return a;\n        const r = c[t];\n        let l;\n        return l = o ? this.anchors.slice([r, 0], [1, 2]) : this.anchorsData[r], {\n          box: a,\n          landmarks: slice(e, [r, NUM_LANDMARKS - 1], [1, -1]).squeeze().reshape([NUM_LANDMARKS, -1]),\n          probability: slice(n, [r], [1]),\n          anchor: l\n        };\n      });\n      u.push(a);\n    }\n\n    return i.dispose(), n.dispose(), e.dispose(), {\n      boxes: u,\n      scaleFactor: p\n    };\n  }\n\n  async estimateFaces(t, o = !1, s = !1, e = !0) {\n    const [, i] = getInputTensorDimensions(t),\n          n = tidy(() => (t instanceof Tensor || (t = browser.fromPixels(t)), t.toFloat().expandDims(0))),\n          {\n      boxes: a,\n      scaleFactor: r\n    } = await this.getBoundingBoxes(n, o, e);\n    return n.dispose(), o ? a.map(t => {\n      const o = scaleBoxFromPrediction(t, r);\n      let n = {\n        topLeft: o.slice([0], [2]),\n        bottomRight: o.slice([2], [2])\n      };\n\n      if (e) {\n        const {\n          landmarks: o,\n          probability: s,\n          anchor: e\n        } = t,\n              i = o.add(e).mul(r);\n        n.landmarks = i, n.probability = s;\n      }\n\n      return s && (n = flipFaceHorizontal(n, i)), n;\n    }) : Promise.all(a.map(async t => {\n      const o = scaleBoxFromPrediction(t, r);\n      let n;\n\n      if (e) {\n        const [s, e, i] = await Promise.all([t.landmarks, o, t.probability].map(async t => t.array())),\n              a = t.anchor,\n              [c, l] = r,\n              d = s.map(t => [(t[0] + a[0]) * c, (t[1] + a[1]) * l]);\n        n = {\n          topLeft: e.slice(0, 2),\n          bottomRight: e.slice(2),\n          landmarks: d,\n          probability: i\n        }, disposeBox(t.box), t.landmarks.dispose(), t.probability.dispose();\n      } else {\n        const t = await o.array();\n        n = {\n          topLeft: t.slice(0, 2),\n          bottomRight: t.slice(2)\n        };\n      }\n\n      return o.dispose(), s && (n = flipFaceHorizontal(n, i)), n;\n    }));\n  }\n\n}\n\nconst BLAZEFACE_MODEL_URL = \"https://tfhub.dev/tensorflow/tfjs-model/blazeface/1/default/1\";\n\nasync function load({\n  maxFaces: t = 10,\n  inputWidth: o = 128,\n  inputHeight: s = 128,\n  iouThreshold: e = .3,\n  scoreThreshold: i = .75\n} = {}) {\n  const n = await loadGraphModel(BLAZEFACE_MODEL_URL, {\n    fromTFHub: !0\n  });\n  return new BlazeFaceModel(n, o, s, t, e, i);\n}\n\nexport { load, BlazeFaceModel };","map":{"version":3,"sources":["/Users/ethan/Desktop/smileai/node_modules/@tensorflow-models/blazeface/dist/blazeface.esm.js"],"names":["slice","add","div","sub","mul","concat2d","Tensor","tidy","concat","tensor1d","tensor2d","sigmoid","image","browser","loadGraphModel","disposeBox","t","startEndTensor","dispose","startPoint","endPoint","createBox","scaleBox","o","s","e","i","ANCHORS_CONFIG","strides","anchors","NUM_LANDMARKS","generateAnchors","length","n","a","Math","floor","r","c","push","decodeBounds","l","d","h","p","getInputTensorDimensions","shape","height","width","flipFaceHorizontal","topLeft","bottomRight","landmarks","map","probability","clone","scaleBoxFromPrediction","hasOwnProperty","box","squeeze","BlazeFaceModel","constructor","blazeFaceModel","maxFaces","anchorsData","inputSizeData","inputSize","iouThreshold","scoreThreshold","getBoundingBoxes","resizeBilinear","predict","console","warn","nonMaxSuppression","array","Promise","all","u","reshape","anchor","boxes","scaleFactor","estimateFaces","fromPixels","toFloat","expandDims","BLAZEFACE_MODEL_URL","load","inputWidth","inputHeight","fromTFHub"],"mappings":"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","sourcesContent":["/**\n    * @license\n    * Copyright 2020 Google LLC. All Rights Reserved.\n    * Licensed under the Apache License, Version 2.0 (the \"License\");\n    * you may not use this file except in compliance with the License.\n    * You may obtain a copy of the License at\n    *\n    * http://www.apache.org/licenses/LICENSE-2.0\n    *\n    * Unless required by applicable law or agreed to in writing, software\n    * distributed under the License is distributed on an \"AS IS\" BASIS,\n    * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    * See the License for the specific language governing permissions and\n    * limitations under the License.\n    * =============================================================================\n    */\nimport{slice,add,div,sub,mul,concat2d,Tensor,tidy,concat,tensor1d,tensor2d,sigmoid,image,browser}from\"@tensorflow/tfjs-core\";import{loadGraphModel}from\"@tensorflow/tfjs-converter\";const disposeBox=t=>{t.startEndTensor.dispose(),t.startPoint.dispose(),t.endPoint.dispose()},createBox=t=>({startEndTensor:t,startPoint:slice(t,[0,0],[-1,2]),endPoint:slice(t,[0,2],[-1,2])}),scaleBox=(t,o)=>{const s=mul(t.startPoint,o),e=mul(t.endPoint,o),i=concat2d([s,e],1);return createBox(i)},ANCHORS_CONFIG={strides:[8,16],anchors:[2,6]},NUM_LANDMARKS=6;function generateAnchors(t,o,s){const e=[];for(let i=0;i<s.strides.length;i++){const n=s.strides[i],a=Math.floor((o+n-1)/n),r=Math.floor((t+n-1)/n),c=s.anchors[i];for(let t=0;t<a;t++){const o=n*(t+.5);for(let t=0;t<r;t++){const s=n*(t+.5);for(let t=0;t<c;t++)e.push([s,o])}}}return e}function decodeBounds(t,o,s){const e=slice(t,[0,1],[-1,2]),i=add(e,o),n=slice(t,[0,3],[-1,2]),a=div(n,s),r=div(i,s),c=div(a,2),l=sub(r,c),d=add(r,c),h=mul(l,s),p=mul(d,s);return concat2d([h,p],1)}function getInputTensorDimensions(t){return t instanceof Tensor?[t.shape[0],t.shape[1]]:[t.height,t.width]}function flipFaceHorizontal(t,o){let s,e,i;if(t.topLeft instanceof Tensor&&t.bottomRight instanceof Tensor){const[n,a]=tidy(()=>[concat([sub(o-1,t.topLeft.slice(0,1)),t.topLeft.slice(1,1)]),concat([sub(o-1,t.bottomRight.slice(0,1)),t.bottomRight.slice(1,1)])]);s=n,e=a,null!=t.landmarks&&(i=tidy(()=>{const s=sub(tensor1d([o-1,0]),t.landmarks),e=tensor1d([1,-1]);return mul(s,e)}))}else{const[n,a]=t.topLeft,[r,c]=t.bottomRight;s=[o-1-n,a],e=[o-1-r,c],null!=t.landmarks&&(i=t.landmarks.map(t=>[o-1-t[0],t[1]]))}const n={topLeft:s,bottomRight:e};return null!=i&&(n.landmarks=i),null!=t.probability&&(n.probability=t.probability instanceof Tensor?t.probability.clone():t.probability),n}function scaleBoxFromPrediction(t,o){return tidy(()=>{let s;return s=t.hasOwnProperty(\"box\")?t.box:t,scaleBox(s,o).startEndTensor.squeeze()})}class BlazeFaceModel{constructor(t,o,s,e,i,n){this.blazeFaceModel=t,this.width=o,this.height=s,this.maxFaces=e,this.anchorsData=generateAnchors(o,s,ANCHORS_CONFIG),this.anchors=tensor2d(this.anchorsData),this.inputSizeData=[o,s],this.inputSize=tensor1d([o,s]),this.iouThreshold=i,this.scoreThreshold=n}async getBoundingBoxes(t,o,s=!0){const[e,i,n]=tidy(()=>{const o=t.resizeBilinear([this.width,this.height]),s=mul(sub(o.div(255),.5),2),e=this.blazeFaceModel.predict(s).squeeze(),i=decodeBounds(e,this.anchors,this.inputSize),n=slice(e,[0,0],[-1,1]);return[e,i,sigmoid(n).squeeze()]}),a=console.warn;console.warn=(()=>{});const r=image.nonMaxSuppression(i,n,this.maxFaces,this.iouThreshold,this.scoreThreshold);console.warn=a;const c=await r.array();r.dispose();let l=c.map(t=>slice(i,[t,0],[1,-1]));o||(l=await Promise.all(l.map(async t=>{const o=await t.array();return t.dispose(),o})));const d=t.shape[1],h=t.shape[2];let p;p=o?div([h,d],this.inputSize):[h/this.inputSizeData[0],d/this.inputSizeData[1]];const u=[];for(let t=0;t<l.length;t++){const i=l[t],a=tidy(()=>{const a=createBox(i instanceof Tensor?i:tensor2d(i));if(!s)return a;const r=c[t];let l;return l=o?this.anchors.slice([r,0],[1,2]):this.anchorsData[r],{box:a,landmarks:slice(e,[r,NUM_LANDMARKS-1],[1,-1]).squeeze().reshape([NUM_LANDMARKS,-1]),probability:slice(n,[r],[1]),anchor:l}});u.push(a)}return i.dispose(),n.dispose(),e.dispose(),{boxes:u,scaleFactor:p}}async estimateFaces(t,o=!1,s=!1,e=!0){const[,i]=getInputTensorDimensions(t),n=tidy(()=>(t instanceof Tensor||(t=browser.fromPixels(t)),t.toFloat().expandDims(0))),{boxes:a,scaleFactor:r}=await this.getBoundingBoxes(n,o,e);return n.dispose(),o?a.map(t=>{const o=scaleBoxFromPrediction(t,r);let n={topLeft:o.slice([0],[2]),bottomRight:o.slice([2],[2])};if(e){const{landmarks:o,probability:s,anchor:e}=t,i=o.add(e).mul(r);n.landmarks=i,n.probability=s}return s&&(n=flipFaceHorizontal(n,i)),n}):Promise.all(a.map(async t=>{const o=scaleBoxFromPrediction(t,r);let n;if(e){const[s,e,i]=await Promise.all([t.landmarks,o,t.probability].map(async t=>t.array())),a=t.anchor,[c,l]=r,d=s.map(t=>[(t[0]+a[0])*c,(t[1]+a[1])*l]);n={topLeft:e.slice(0,2),bottomRight:e.slice(2),landmarks:d,probability:i},disposeBox(t.box),t.landmarks.dispose(),t.probability.dispose()}else{const t=await o.array();n={topLeft:t.slice(0,2),bottomRight:t.slice(2)}}return o.dispose(),s&&(n=flipFaceHorizontal(n,i)),n}))}}const BLAZEFACE_MODEL_URL=\"https://tfhub.dev/tensorflow/tfjs-model/blazeface/1/default/1\";async function load({maxFaces:t=10,inputWidth:o=128,inputHeight:s=128,iouThreshold:e=.3,scoreThreshold:i=.75}={}){const n=await loadGraphModel(BLAZEFACE_MODEL_URL,{fromTFHub:!0});return new BlazeFaceModel(n,o,s,t,e,i)}export{load,BlazeFaceModel};\n"]},"metadata":{},"sourceType":"module"}